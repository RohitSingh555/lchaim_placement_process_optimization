{% extends "base.html" %} {% load static %} {% block content %}
<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-3xl font-semibold mb-6 text-teal-700">
    Assign Facility & Orientation
  </h1>

  <form method="post" action="{% url 'assign_facility' %}">
    {% csrf_token %}

    <div class="mt-6 flex flex-col md:flex-row items-center gap-4 pb-4">
      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Facility
        </label>
        <select
          name="facility_id"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500"
        >
          <option value="">Select a Facility</option>
          {% for facility in facilities %}
          <option value="{{ facility.id }}">
            {{ facility.name }} - {{ facility.city }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Orientation Date
        </label>
        <input
          type="text"
          id="orientation-date-picker"
          name="orientation_date"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500 transition duration-150 ease-in-out shadow-sm hover:border-teal-400 hover:shadow-md"
          placeholder="Select a date"
          readonly
        />
      </div>

      <div class="w-full md:w-auto mt-4 md:mt-7">
        <button
          type="submit"
          class="inline-flex items-center px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg shadow"
        >
          Assign
        </button>
      </div>
    </div>

    <div class="mt-6 flex items-center gap-4">
      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Search by Name
        </label>
        <input
          type="text"
          id="search-bar"
          class="w-full border border-gray-300 rounded-lg px-3 py-2"
          placeholder="Search by Name"
        />
      </div>

      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Filter by Orientation
        </label>
        <select
          id="orientation-filter"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500"
        >
          <option value="">All</option>
          {% for date in orientation_dates %}
          <option value="{{ date.id }}">
            {{ date.orientation_date|date:"M d, Y" }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div
      class="overflow-x-auto shadow rounded-lg border border-gray-200 bg-white mt-6"
    >
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-teal-50">
          <tr>
            <th class="px-6 py-3">
              <input
                type="checkbox"
                id="select-all"
                onclick="toggleSelectAll(this)"
                class="w-5 h-5 accent-teal-600 rounded border-gray-300"
              />
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
            >
              Email
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
            >
              Experience
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
            >
              Assigned Facility
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider"
            >
              Orientation Date
            </th>
          </tr>
        </thead>
        <tbody
          class="bg-white divide-y divide-gray-200"
          id="profile-table-body"
        >
          {% for profile in profiles %}
          <tr
            class="hover:bg-teal-50 cursor-pointer"
            onclick="toggleRowCheckbox(this)"
            data-orientation-id="{{ profile.orientation_date.id }}"
          >
            <td class="px-6 py-4 whitespace-nowrap">
              <input
                type="checkbox"
                name="selected_users"
                value="{{ profile.user.id }}"
                class="user-checkbox w-5 h-5 accent-teal-600"
              />
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {{ profile.first_name }} {{ profile.last_name }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {{ profile.college_email }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {{ profile.experience_level }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if profile.assigned_facility %}
              <span>{{ profile.assigned_facility.name }} </span>
              {% else %}
              <span class="text-gray-500 italic">Not Assigned</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if profile.orientation_date %}
              <span
                >{{profile.orientation_date.orientation_date|date:"M d, Y" }}
              </span>
              {% else %}
              <span class="text-gray-500 italic">Not Assigned</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center py-4 text-gray-500">
              No profiles found.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Custom highlight for orientation dates */
    .flatpickr-day.orientation-highlight {
      background: linear-gradient(135deg, #14b8a6 60%, #2dd4bf 100%);
      color: #fff;
      font-weight: bold;
      border-radius: 50% !important;
      box-shadow: 0 2px 8px rgba(20,184,166,0.15);
      border: 2px solid #0f766e;
      transition: background 0.2s, color 0.2s;
    }
    .flatpickr-day.orientation-highlight:hover {
      background: linear-gradient(135deg, #0f766e 60%, #14b8a6 100%);
      color: #fff;
    }
    /* Message styling */
    .no-orientation-msg {
      color: #0f766e;
      font-size: 1rem;
      text-align: center;
      margin: 1.5em 0 0.5em 0;
      font-weight: 600;
      background: #f0fdfa;
      border-radius: 0.5em;
      padding: 0.5em 0.5em;
    }
  </style>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll(".user-checkbox");
    checkboxes.forEach((cb) => (cb.checked = source.checked));
  }

  document.addEventListener("DOMContentLoaded", function () {
    const checkboxes = document.querySelectorAll(".user-checkbox");
    const selectAll = document.getElementById("select-all");

    checkboxes.forEach((cb) => {
      cb.addEventListener("click", (e) => e.stopPropagation());
      cb.addEventListener("change", () => {
        if (!cb.checked) {
          selectAll.checked = false;
        } else if ([...checkboxes].every((c) => c.checked)) {
          selectAll.checked = true;
        }
      });
    });

    // Pass your orientation dates from Django to JS
    const orientationDates = [
      {% for date in orientation_dates %}
        "{{ date.orientation_date|date:'Y-m-d' }}",
      {% endfor %}
    ];
    // Use a Set for fast lookup
    const orientationDateSet = new Set(orientationDates);

    // Helper: get all orientation dates for a given month/year
    function getMonthOrientationDates(year, month) {
      return orientationDates.filter(dateStr => {
        const d = new Date(dateStr + 'T00:00:00');
        return d.getFullYear() === year && d.getMonth() === month;
      });
    }

    flatpickr("#orientation-date-picker", {
      enable: orientationDates,
      dateFormat: "Y-m-d",
      allowInput: false,
      clickOpens: true,
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        // Highlight enabled/orientation dates (compare local date, not UTC)
        const date = dayElem.dateObj;
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        const ymd = `${y}-${m}-${d}`;
        if (orientationDateSet.has(ymd)) {
          dayElem.classList.add("orientation-highlight");
        }
      },
      onMonthChange: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      },
      onOpen: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      },
      onYearChange: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      }
    });

    function showNoOrientationMsg(instance) {
      // Remove any previous message
      const cal = instance.calendarContainer;
      let msg = cal.querySelector('.no-orientation-msg');
      if (msg) msg.remove();
      // Get current month/year
      const month = instance.currentMonth;
      const year = instance.currentYear;
      const monthDates = getMonthOrientationDates(year, month);
      if (monthDates.length === 0) {
        // Insert message below days grid
        const days = cal.querySelector('.flatpickr-days');
        if (days) {
          msg = document.createElement('div');
          msg.className = 'no-orientation-msg';
          msg.textContent = 'No orientation dates in this month';
          days.parentNode.insertBefore(msg, days.nextSibling);
        }
      }
    }

    // Search by Name
    const searchInput = document.getElementById("search-bar");
    searchInput.addEventListener("input", filterRows);

    // Filter by Orientation
    const orientationFilter = document.getElementById("orientation-filter");
    orientationFilter.addEventListener("change", filterRows);

    function filterRows() {
      const nameFilter = searchInput.value.toLowerCase();
      const orientationId = orientationFilter.value;
      const rows = document.querySelectorAll("#profile-table-body tr");

      rows.forEach((row) => {
        const name =
          row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
        const rowOrientationId = row.getAttribute("data-orientation-id");

        const matchesName = name.includes(nameFilter);
        const matchesOrientation =
          !orientationId || rowOrientationId === orientationId;

        row.style.display = matchesName && matchesOrientation ? "" : "none";
      });
    }
  });

  function toggleRowCheckbox(row) {
    const checkbox = row.querySelector(".user-checkbox");
    if (checkbox) {
      checkbox.checked = !checkbox.checked;
      checkbox.dispatchEvent(new Event("change"));
    }
  }
</script>
{% endblock %} {% endblock %}
