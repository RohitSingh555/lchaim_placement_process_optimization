{% extends "base.html" %} {% load static %} {% block content %}
<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-3xl font-semibold mb-6 text-teal-700">
    Assign Facility & Orientation
  </h1>

  <!-- Filter Modal Trigger -->
  <div class="flex flex-col md:flex-row items-center gap-4 pb-4">
    <div class="w-full md:w-1/3">
      <label class="block text-sm font-medium text-gray-700 mb-1">Search by Name or Student ID</label>
      <input type="text" name="search" id="search-bar" value="{{ request.GET.search|default:'' }}" placeholder="Search by name or student ID..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150 ease-in-out" />
    </div>
    <div class="w-full md:w-auto mt-4 md:mt-7 flex items-center gap-2">
      <button type="button" onclick="openFilterModal()" class="inline-flex items-center px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg shadow"><i class="fas fa-filter mr-2"></i>Filters</button>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filterModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-40 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg relative">
      <button type="button" onclick="closeFilterModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
      <h2 class="text-xl font-bold text-teal-700 mb-6 flex items-center gap-2"><i class="fas fa-sliders-h"></i> Filters</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Facility</label>
          <select name="assigned_facility" id="assigned-facility-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Facilities</option>
            {% for facility in facilities %}
              {% if facility.status == 'ACTIVE' or facility.status == 'Active' %}
                <option value="{{ facility.id }}" data-city="{{ facility.city }}" {% if facility.id|stringformat:'s' == selected_facility %}selected{% endif %}>{{ facility.name }} - {{ facility.city }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Orientation Date</label>
          <select name="orientation_date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Dates</option>
            {% for date in orientation_dates %}
              <option value="{{ date.id }}" {% if date.id|stringformat:'s' == selected_orientation_date %}selected{% endif %}>{{ date.orientation_date|date:"M d, Y" }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select name="status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-cyan-500 focus:border-cyan-500 bg-cyan-50 text-cyan-800 font-semibold rounded-md">
            <option value="">All Statuses</option>
            {% for status in status_choices %}
              <option value="{{ status }}" {% if status == selected_status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
          <select name="facility_city" id="facility-city-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Cities</option>
            {% for city in cities %}
              <option value="{{ city.name }}" {% if city.name == selected_city %}selected{% endif %}>{{ city.province }} - {{ city.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Student Home City</label>
          <select name="student_home_city" id="student-home-city-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Cities</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Municipality</label>
          <select name="municipality" id="municipality-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Municipalities</option>
            <option value="Downtown">Downtown</option>
            <option value="Etobicoke">Etobicoke</option>
            <option value="Scarborough">Scarborough</option>
            <option value="North York">North York</option>
            <option value="East York">East York</option>
            <option value="York">York</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Preferred City 1</label>
          <select name="preferred_city_1" id="preferred-city-1-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Cities</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Preferred City 2</label>
          <select name="preferred_city_2" id="preferred-city-2-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
            <option value="">All Cities</option>
          </select>
        </div>
      </div>
      <div class="flex justify-end mt-8 gap-2">
        <button type="button" onclick="closeFilterModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Assignment Form (POST) -->
  <form method="post" action="{% url 'assign_facility' %}">
    {% csrf_token %}
    <div class="mt-6 flex flex-col md:flex-row items-center gap-4 pb-4">
      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">Facility</label>
        <select name="facility_id" id="facility-id-assignment" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500">
          <option value="">Select a Facility</option>
          {# Only show facilities with Active status #}
          {% for facility in facilities %}
            {% if facility.status == 'ACTIVE' or facility.status == 'Active' %}
              <option value="{{ facility.id }}" data-city="{{ facility.city }}">{{ facility.name }} - {{ facility.city }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="w-full md:w-1/3">
        <label class="block text-sm font-medium text-gray-700 mb-1">Orientation Date</label>
        <input type="text" id="orientation-date-picker" name="orientation_id" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-teal-500 focus:border-teal-500 transition duration-150 ease-in-out shadow-sm hover:border-teal-400 hover:shadow-md" placeholder="Select a date" readonly />
      </div>
      <div class="w-full md:w-auto mt-4 md:mt-7">
        <button type="submit" class="inline-flex items-center px-6 py-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg shadow">Assign</button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-2xl shadow-lg border border-gray-200 bg-white mt-6">
      <table class="min-w-full divide-y divide-gray-200 rounded-2xl overflow-hidden text-sm md:text-base whitespace-nowrap" style="table-layout: auto;">
        <thead class="bg-gradient-to-r from-teal-50 to-cyan-50 sticky top-0 z-10">
          <tr>
            <th class="px-4 py-3 whitespace-nowrap" style="min-width: 60px;">
              <div class="flex items-center justify-center">
                <input type="checkbox" id="select-all" onclick="toggleSelectAll(this)" title="Select All" class="w-5 h-5 accent-teal-600 align-middle" />
              </div>
            </th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider sticky left-0 bg-gradient-to-r from-teal-50 to-cyan-50 z-20" style="min-width: 110px;">Student ID</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 120px;">Name</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 170px;">Email</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 110px;">Experience</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 150px;">Assigned Facility</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 140px;">Orientation Date</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 110px;">Start Date</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 110px;">End Date</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-teal-700 uppercase tracking-wider" style="min-width: 100px;">Status</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100" id="profile-table-body">
          {% for profile in profiles %}
          <tr class="hover:bg-gradient-to-r hover:from-teal-50 hover:to-cyan-50 transition-all cursor-pointer group" data-home-city="{{ profile.city }}" data-municipality="{{ profile.municipality }}" data-pref-city-1="{{ profile.city_preference_1 }}" data-pref-city-2="{{ profile.city_preference_2 }}">
            <td class="px-4 py-4 whitespace-nowrap" data-label="Select / Profile" style="text-align: center; vertical-align: middle;">
              <div class="flex items-center justify-center gap-3 h-full">
                <input type="checkbox" name="selected_users" value="{{ profile.user.id }}" class="user-checkbox w-4 h-4 accent-teal-600 align-middle cursor-pointer" style="min-width: 18px; min-height: 18px;" onclick="event.stopPropagation();" />
                <a href="{% url 'get_student_profile_by_id' profile.id %}" target="_blank" onclick="event.stopPropagation();" title="Open profile in new tab" class="text-teal-700 hover:text-teal-900 flex items-center justify-center" style="font-size: 2rem; line-height: 1;">
                  <i class="fas fa-user-circle"></i>
                </a>
              </div>
            </td>
            <td class="px-4 py-4 font-mono font-semibold text-teal-800 bg-gradient-to-r from-white to-teal-50 sticky left-0 z-10 group-hover:bg-cyan-50 whitespace-nowrap" data-label="Student ID">{% if profile.student_id %}<a href="{% url 'get_student_profile_by_id' profile.id %}" class="underline hover:text-teal-900" target="_blank">{{ profile.student_id }}</a>{% else %}<span class="text-gray-400 italic">N/A</span>{% endif %}</td>
            <td class="px-4 py-4 font-semibold text-gray-800 whitespace-nowrap" data-label="Name">{{ profile.first_name }} {{ profile.last_name }}</td>
            <td class="px-4 py-4 text-gray-600 whitespace-nowrap" data-label="Email">{{ profile.college_email }}</td>
            <td class="px-4 py-4 text-gray-600 whitespace-nowrap" data-label="Experience">{{ profile.experience_level }}</td>
            <td class="px-4 py-4 whitespace-nowrap" data-label="Assigned Facility">{% if profile.assigned_facility %}<span class="font-medium text-teal-700">{{ profile.assigned_facility.name }}</span>{% else %}<span class="text-gray-400 italic">Not Assigned</span>{% endif %}</td>
            <td class="px-4 py-4 whitespace-nowrap" data-label="Orientation Date">{% if profile.orientation_date %}<span class="text-teal-700">{{ profile.orientation_date.orientation_date|date:"M d, Y" }}</span>{% else %}<span class="text-gray-400 italic">Not Assigned</span>{% endif %}</td>
            <td class="px-4 py-4 whitespace-nowrap" data-label="Start Date">{% if profile.official_start_date %}{{ profile.official_start_date|date:"M d, Y" }}{% else %}<span class="text-gray-400 italic">N/A</span>{% endif %}</td>
            <td class="px-4 py-4 whitespace-nowrap" data-label="End Date">{% if profile.exact_placement_end_date %}{{ profile.exact_placement_end_date|date:"M d, Y" }}{% else %}<span class="text-gray-400 italic">N/A</span>{% endif %}</td>
            <td class="px-4 py-4 whitespace-nowrap" data-label="Status">
              <span class="inline-flex items-center px-3 py-1 rounded-full font-semibold tracking-wide text-xs
                {% if profile.stage == 'IN_PLACEMENT' %}bg-green-100 text-green-700
                {% elif profile.stage == 'ONGOING_PROCESS' %}bg-yellow-100 text-yellow-700
                {% elif profile.stage == 'DONE' %}bg-teal-100 text-teal-700
                {% elif profile.stage == 'CANCELLED' %}bg-red-100 text-red-700
                {% elif profile.stage == 'ONHOLD' %}bg-gray-100 text-gray-700
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {% if profile.stage == 'IN_PLACEMENT' %}<i class="fas fa-check-circle mr-1"></i>
                {% elif profile.stage == 'ONGOING_PROCESS' %}<i class="fas fa-spinner mr-1 animate-spin-slow"></i>
                {% elif profile.stage == 'DONE' %}<i class="fas fa-flag-checkered mr-1"></i>
                {% elif profile.stage == 'CANCELLED' %}<i class="fas fa-times-circle mr-1"></i>
                {% elif profile.stage == 'ONHOLD' %}<i class="fas fa-pause-circle mr-1"></i>
                {% else %}<i class="fas fa-question-circle mr-1"></i>{% endif %}
                {{ profile.stage|title }}
              </span>
              <!-- Notify Placement Button -->
              <button onclick="sendEmailAction('{{ profile.id }}', 'notify_placement')" class="ml-2 bg-orange-500 text-white px-3 py-1 rounded-md text-xs font-semibold hover:bg-orange-600 flex items-center gap-1">
                <i class="fas fa-building"></i> Notify Placement
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center py-8 text-gray-400 text-lg font-semibold">No profiles found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</div>

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Custom highlight for orientation dates */
    .flatpickr-day.orientation-highlight {
      background: linear-gradient(135deg, #14b8a6 60%, #2dd4bf 100%);
      color: #fff;
      font-weight: bold;
      border-radius: 50% !important;
      box-shadow: 0 2px 8px rgba(20,184,166,0.15);
      border: 2px solid #0f766e;
      transition: background 0.2s, color 0.2s;
    }
    .flatpickr-day.orientation-highlight:hover {
      background: linear-gradient(135deg, #0f766e 60%, #14b8a6 100%);
      color: #fff;
    }
    /* Message styling */
    .no-orientation-msg {
      color: #0f766e;
      font-size: 1rem;
      text-align: center;
      margin: 1.5em 0 0.5em 0;
      font-weight: 600;
      background: #f0fdfa;
      border-radius: 0.5em;
      padding: 0.5em 0.5em;
    }
    th, td {
      white-space: nowrap;
      vertical-align: middle;
    }
  </style>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"></script>
<script>
  // --- Checkbox Select All Logic ---
  function toggleSelectAll(source) {
    const checkboxes = document.querySelectorAll(".user-checkbox");
    checkboxes.forEach((cb) => (cb.checked = source.checked));
  }

  function updateSelectAllCheckbox() {
    const checkboxes = document.querySelectorAll(".user-checkbox");
    const selectAll = document.getElementById("select-all");
    if (!selectAll) return;
    selectAll.checked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
  }

  // --- Fetch city list for city-based filters ---
  function populateCityDropdown(selectId) {
    fetch('/cities-and-provinces/')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById(selectId);
        if (!select) return;
        // Remove all except the first option
        while (select.options.length > 1) select.remove(1);
        Object.keys(data).forEach(province => {
          data[province].forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.text = province + ' - ' + city;
            select.appendChild(opt);
          });
        });
      });
  }
  document.addEventListener('DOMContentLoaded', function() {
    populateCityDropdown('student-home-city-filter');
    populateCityDropdown('preferred-city-1-filter');
    populateCityDropdown('preferred-city-2-filter');
    // --- Checkbox logic ---
    const checkboxes = document.querySelectorAll(".user-checkbox");
    const selectAll = document.getElementById("select-all");
    checkboxes.forEach((cb) => {
      cb.addEventListener("click", (e) => e.stopPropagation());
      cb.addEventListener("change", updateSelectAllCheckbox);
    });
    if (selectAll) {
      selectAll.addEventListener("change", function() {
        toggleSelectAll(this);
      });
    }
    updateSelectAllCheckbox();

    // --- Orientation Dates for Flatpickr ---
    const orientationDates = [
      {% for date in orientation_dates %}
        "{{ date.orientation_date|date:'Y-m-d' }}",
      {% endfor %}
    ];
    const orientationDateSet = new Set(orientationDates);
    function getMonthOrientationDates(year, month) {
      return orientationDates.filter(dateStr => {
        const d = new Date(dateStr + 'T00:00:00');
        return d.getFullYear() === year && d.getMonth() === month;
      });
    }
    flatpickr("#orientation-date-picker", {
      enable: orientationDates,
      dateFormat: "Y-m-d",
      allowInput: false,
      clickOpens: true,
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const date = dayElem.dateObj;
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        const ymd = `${y}-${m}-${d}`;
        if (orientationDateSet.has(ymd)) {
          dayElem.classList.add("orientation-highlight");
        }
      },
      onMonthChange: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      },
      onOpen: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      },
      onYearChange: function(selectedDates, dateStr, instance) {
        showNoOrientationMsg(instance);
      }
    });
    function showNoOrientationMsg(instance) {
      const cal = instance.calendarContainer;
      let msg = cal.querySelector('.no-orientation-msg');
      if (msg) msg.remove();
      const month = instance.currentMonth;
      const year = instance.currentYear;
      const monthDates = getMonthOrientationDates(year, month);
      if (monthDates.length === 0) {
        const days = cal.querySelector('.flatpickr-days');
        if (days) {
          msg = document.createElement('div');
          msg.className = 'no-orientation-msg';
          msg.textContent = 'No orientation dates in this month';
          days.parentNode.insertBefore(msg, days.nextSibling);
        }
      }
    }

    // --- Unified Filter Logic ---
    const searchInput = document.getElementById("search-bar");
    const facilityFilter = document.getElementById('assigned-facility-filter');
    const orientationFilter = document.querySelector('select[name="orientation_date"]');
    const statusFilter = document.querySelector('select[name="status"]');
    const cityFilter = document.getElementById('facility-city-filter');
    const homeCityFilter = document.getElementById('student-home-city-filter');
    const municipalityFilter = document.getElementById('municipality-filter');
    const preferredCity1Filter = document.getElementById('preferred-city-1-filter');
    const preferredCity2Filter = document.getElementById('preferred-city-2-filter');
    const applyFiltersBtn = document.querySelector('#filterModal button[type="submit"]');
    const rows = document.querySelectorAll("#profile-table-body tr");

    function applyAllFilters() {
      const searchVal = (searchInput?.value || '').toLowerCase();
      const facilityVal = facilityFilter?.value || '';
      const orientationVal = orientationFilter?.value || '';
      const statusVal = statusFilter?.value || '';
      const cityVal = cityFilter?.value || '';
      const homeCityVal = homeCityFilter?.value || '';
      const municipalityVal = municipalityFilter?.value || '';
      const preferredCity1Val = preferredCity1Filter?.value || '';
      const preferredCity2Val = preferredCity2Filter?.value || '';
      rows.forEach(row => {
        // Skip empty row (no profiles)
        if (row.querySelectorAll('td').length < 2) {
          row.style.display = '';
          return;
        }
        const name = row.querySelector("td:nth-child(3)")?.textContent.toLowerCase() || "";
        const studentId = row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
        const facility = row.querySelector("td:nth-child(6)")?.textContent.trim() || "";
        const orientation = row.querySelector("td:nth-child(7)")?.textContent.trim() || "";
        const status = row.querySelector("td:nth-child(10)")?.textContent.trim().toLowerCase() || "";
        const rowHomeCity = row.getAttribute('data-home-city') || '';
        const rowMunicipality = row.getAttribute('data-municipality') || '';
        const rowPrefCity1 = row.getAttribute('data-pref-city-1') || '';
        const rowPrefCity2 = row.getAttribute('data-pref-city-2') || '';
        let show = true;
        if (searchVal && !(name.includes(searchVal) || studentId.includes(searchVal))) show = false;
        if (facilityVal && !facility.includes(facilityFilter.options[facilityFilter.selectedIndex].text.split(' - ')[0])) show = false;
        if (orientationVal && !orientation.includes(orientationFilter.options[orientationFilter.selectedIndex].text)) show = false;
        if (statusVal && !status.includes(statusVal.toLowerCase())) show = false;
        if (cityVal && city !== cityVal) show = false;
        if (homeCityVal && rowHomeCity !== homeCityVal) show = false;
        if (municipalityVal && rowMunicipality !== municipalityVal) show = false;
        if (preferredCity1Val && rowPrefCity1 !== preferredCity1Val) show = false;
        if (preferredCity2Val && rowPrefCity2 !== preferredCity2Val) show = false;
        row.style.display = show ? '' : 'none';
      });
      // --- Facility dropdown filtering ---
      const facilityAssign = document.getElementById('facility-id-assignment');
      if (facilityAssign) {
        Array.from(facilityAssign.options).forEach(opt => {
          if (!homeCityVal || opt.value === '' || opt.getAttribute('data-city') === homeCityVal) {
            opt.style.display = '';
          } else {
            opt.style.display = 'none';
          }
        });
      }
    }

    if (searchInput) searchInput.addEventListener("input", applyAllFilters);
    if (facilityFilter) facilityFilter.addEventListener("change", applyAllFilters);
    if (orientationFilter) orientationFilter.addEventListener("change", applyAllFilters);
    if (statusFilter) statusFilter.addEventListener("change", applyAllFilters);
    if (cityFilter) cityFilter.addEventListener("change", applyAllFilters);
    if (homeCityFilter) homeCityFilter.addEventListener('change', applyAllFilters);
    if (municipalityFilter) municipalityFilter.addEventListener('change', applyAllFilters);
    if (preferredCity1Filter) preferredCity1Filter.addEventListener('change', applyAllFilters);
    if (preferredCity2Filter) preferredCity2Filter.addEventListener('change', applyAllFilters);
    if (applyFiltersBtn) {
      applyFiltersBtn.addEventListener('click', function(e) {
        e.preventDefault();
        closeFilterModal();
        applyAllFilters();
      });
    }

    // City filter logic for facilities (dropdown options)
    function filterFacilitiesByCity(city) {
      // Filter in filter form
      if (facilityFilter) {
        Array.from(facilityFilter.options).forEach(opt => {
          if (!city || opt.value === '' || opt.getAttribute('data-city') === city) {
            opt.style.display = '';
          } else {
            opt.style.display = 'none';
          }
        });
      }
      // Filter in assignment form
      const facilityAssign = document.getElementById('facility-id-assignment');
      if (facilityAssign) {
        Array.from(facilityAssign.options).forEach(opt => {
          if (!city || opt.value === '' || opt.getAttribute('data-city') === city) {
            opt.style.display = '';
          } else {
            opt.style.display = 'none';
          }
        });
      }
    }
    if (cityFilter) {
      cityFilter.addEventListener('change', function() {
        filterFacilitiesByCity(this.value);
      });
      if (cityFilter.value) {
        filterFacilitiesByCity(cityFilter.value);
      }
    }
  });

  function toggleRowCheckbox(row) {
    const checkbox = row.querySelector(".user-checkbox");
    if (checkbox) {
      checkbox.checked = !checkbox.checked;
      checkbox.dispatchEvent(new Event("change"));
    }
  }

  // Modal logic for filters
  function openFilterModal() {
    document.getElementById('filterModal').classList.remove('hidden');
  }
  function closeFilterModal() {
    document.getElementById('filterModal').classList.add('hidden');
  }

function sendEmailAction(profileId, action) {
  const url = `/send-email/${profileId}/${action}/`;
  // Show the loading overlay and disable interactions
  let overlay = document.getElementById('loadingOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.innerHTML = '<div class="loader"></div>';
    document.body.appendChild(overlay);
  }
  overlay.style.display = 'flex';
  document.body.style.pointerEvents = 'none';
  fetch(url, { method: 'GET' })
    .then(response => response.json())
    .then(data => {
      overlay.style.display = 'none';
      document.body.style.pointerEvents = 'auto';
      showMessage(data.message, data.status === 'success' ? 'success' : 'error');
    })
    .catch(error => {
      overlay.style.display = 'none';
      document.body.style.pointerEvents = 'auto';
      showMessage('An error occurred while sending the email.', 'error');
    });
}
function showMessage(message, type) {
  let messagePopup = document.getElementById('messagePopup');
  let messageText = document.getElementById('messageText');
  if (!messagePopup) {
    messagePopup = document.createElement('div');
    messagePopup.id = 'messagePopup';
    messagePopup.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden';
    messageText = document.createElement('span');
    messageText.id = 'messageText';
    messagePopup.appendChild(messageText);
    document.body.appendChild(messagePopup);
  }
  messagePopup.classList.remove('hidden');
  messageText.innerText = message;
  if (type === 'success') {
    messagePopup.classList.remove('bg-red-500');
    messagePopup.classList.add('bg-green-500');
  } else {
    messagePopup.classList.remove('bg-green-500');
    messagePopup.classList.add('bg-red-500');
  }
  setTimeout(() => {
    messagePopup.classList.add('hidden');
  }, 4000);
}
</script>
<style>
  #loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    display: none;
  }
  .loader {
    border: 8px solid #f3f3f3;
    border-top: 8px solid #008080;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %} {% endblock %}
