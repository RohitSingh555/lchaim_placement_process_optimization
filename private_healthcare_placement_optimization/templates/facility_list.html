{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-gray-800">Facilities</h2>
    <button onclick="openModal('addFacilityModal')" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow-sm transition">
      + Add Facility
    </button>
  </div>

  <div class="overflow-x-auto bg-white shadow rounded-lg border border-gray-200">
    <table class="min-w-full text-sm text-left text-gray-700">
      <thead class="bg-teal-50 text-teal-700 uppercase text-xs font-semibold">
        <tr>
          <th class="px-6 py-3">Name</th>
          <th class="px-6 py-3">Status</th>
          <th class="px-6 py-3">Province</th>
          <th class="px-6 py-3">City</th>
          <th class="px-6 py-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for facility in facilities %}
        <tr>
          <td class="px-6 py-4 font-medium">{{ facility.name }}</td>
          <td class="px-6 py-4">{{ facility.status }}</td>
          <td class="px-6 py-4">{{ facility.province }}</td>
          <td class="px-6 py-4">{{ facility.city }}</td>
          <td class="px-6 py-4 text-right space-x-2">
            <!-- Edit/Delete buttons go here -->
            <button onclick="openEditModal('{{ facility.id }}')" class="text-blue-600 hover:text-blue-700">
                <i class="fas fa-edit"></i> Edit
              </button>
            <button onclick="confirmDelete('{{ facility.id }}')" class="text-red-600 hover:text-red-700">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
            
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Facility Modal -->
<div id="addFacilityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white max-w-3xl w-full rounded-lg p-6 shadow-xl relative overflow-y-auto max-h-[90vh]">
    <!-- Close Button -->
    <button onclick="closeModal('addFacilityModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      ✕
    </button>

    <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Facility</h3>

    <form method="post" action="{% url 'facility_add' %}" class="space-y-4" id="facilityForm">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Status</label>
          <select name="status" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option value="Active" selected>Active</option>
            <option value="Inactive">Inactive</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Province</label>
          <input name="province" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">City</label>
          <input name="city" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Address</label>
          <textarea name="address" required rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Facility Phone</label>
          <input name="facility_phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Website</label>
          <input type="url" name="website" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Person in Charge</label>
          <input name="person_in_charge" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" name="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Phone Number</label>
          <input name="phone_number" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Designation</label>
          <input name="designation" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Additional Requirements</label>
          <textarea name="additional_requirements" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Shifts Available</label>
          <input name="shifts_available" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Notes</label>
          <textarea name="notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
        </div>
      </div>

      <div class="flex justify-end space-x-3 pt-4">
        <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Submit</button>
        <button type="button" onclick="closeModal('addFacilityModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white max-w-md w-full rounded-lg p-6 shadow-xl relative overflow-y-auto max-h-[90vh]">
    <!-- Close Button -->
    <button onclick="closeModal('deleteConfirmationModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      ✕
    </button>

    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirm Deletion</h3>
    <p class="mb-4 text-gray-600">Are you sure you want to delete this facility? This action cannot be undone.</p>

    <div class="flex justify-end space-x-3 pt-4">
      <button onclick="deleteFacility()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
      <button type="button" onclick="closeModal('deleteConfirmationModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Facility Modal -->
<div id="editFacilityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white max-w-3xl w-full rounded-lg p-6 shadow-xl relative overflow-y-auto max-h-[90vh]">
      <!-- Close Button -->
      <button onclick="closeModal('editFacilityModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
        ✕
      </button>
  
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Edit Facility</h3>
  
      <form method="post" id="facilityEditForm" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input name="name" id="editName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Status</label>
            <select name="status" id="editStatus" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Province</label>
            <input name="province" id="editProvince" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">City</label>
            <input name="city" id="editCity" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700">Address</label>
            <textarea name="address" id="editAddress" required rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Facility Phone</label>
            <input name="facility_phone" id="editFacilityPhone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Website</label>
            <input type="url" name="website" id="editWebsite" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Person in Charge</label>
            <input name="person_in_charge" id="editPersonInCharge" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="email" id="editEmail" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
            <input name="phone_number" id="editPhoneNumber" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Designation</label>
            <input name="designation" id="editDesignation" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700">Additional Requirements</label>
            <textarea name="additional_requirements" id="editAdditionalRequirements" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Shifts Available</label>
            <input name="shifts_available" id="editShiftsAvailable" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
          </div>
  
          <div>
            <label class="block text-sm font-medium text-gray-700">Notes</label>
            <textarea name="notes" id="editNotes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
          </div>
        </div>
  
        <div class="flex justify-end space-x-3 pt-4">
          <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Submit</button>
          <button type="button" onclick="closeModal('editFacilityModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
        </div>
      </form>
    </div>
</div>

  
  <script>
    function openEditModal(facilityId) {
        facilityIdToEdit = facilityId;
        fetchFacilityDetails(facilityId);
        openModal('editFacilityModal');
      }
      
      function fetchFacilityDetails(facilityId) {
        // Fetch facility details from the backend
        fetch(`/facilities/${facilityId}/edit/`)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error(data.error);
              return;
            }
            // Set form action URL for submission
            document.getElementById('facilityEditForm').action = `/facilities/${facilityId}/edit/`;
      
            // Populate form fields with fetched data
            document.getElementById('editName').value = data.name || '';
            document.getElementById('editStatus').value = data.status || '';
            document.getElementById('editProvince').value = data.province || '';
            document.getElementById('editCity').value = data.city || '';
            document.getElementById('editAddress').value = data.address || '';
            document.getElementById('editFacilityPhone').value = data.facility_phone || '';
            document.getElementById('editWebsite').value = data.website || '';
            document.getElementById('editPersonInCharge').value = data.person_in_charge || '';
            document.getElementById('editEmail').value = data.email || '';
            document.getElementById('editPhoneNumber').value = data.phone_number || '';
            document.getElementById('editDesignation').value = data.designation || '';
            document.getElementById('editAdditionalRequirements').value = data.additional_requirements || '';
            document.getElementById('editShiftsAvailable').value = data.shifts_available || '';
            document.getElementById('editNotes').value = data.notes || '';
          })
          .catch(error => {
            console.error('Error fetching facility details:', error);
          });
      }

      document.getElementById('facilityEditForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent default form submission
        
        if (!facilityIdToEdit) {
            console.error("Facility ID is missing for update");
            return;
        }
    
        const formData = new FormData(this);
    
        // Send form data to the backend
        fetch(`/facilities/${facilityIdToEdit}/update/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
            },
        })
        .then(response => {
            // Close the modal when you get any kind of response (302 included)
            closeModal('editFacilityModal');
            
            if (response.status === 302) {
                // Optionally, perform some action before the redirect if necessary
                console.log('Redirect response received');
            } else if (response.ok) {
                return response.json();
            } else {
                throw new Error('Failed to update');
            }
        })
        .then(data => {
            if (data && data.success) {
                // Optionally update the page content or reload if needed
                location.reload(); // or update the UI with the new facility details
            } else {
                console.error('Error updating facility:', data.error);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
        });
    });
    
  </script>
  
<!-- JS Modal Toggle and Delete -->
<script>
  let facilityIdToDelete = null;

  function openModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('hidden');
    setTimeout(() => {
      const input = modal.querySelector('input[name="name"]');
      if (input) input.focus();
    }, 100);
  }

  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  function confirmDelete(facilityId) {
    facilityIdToDelete = facilityId;
    openModal('deleteConfirmationModal');
  }

  function deleteFacility() {
    if (facilityIdToDelete) {
      // Send request to delete the facility (you can use AJAX or form submission)
      window.location.href = `{% url 'facility_delete' 0 %}`.replace('0', facilityIdToDelete);
    }
  }
</script>
{% endblock %}
